---
title: "Daten bereinigen"
author: "Peter Baumgartner"
date: "2017-03-19"
output: 
        html_notebook:
                toc: yes
                toc_depth: 3
                
---
***

```{r label = "global-options", echo=FALSE, highlight=TRUE}
knitr::opts_chunk$set(
        message = F,
        error = F,
        warning = F,
        comment = NA,
        highlight = T,
        prompt = T
        )

if (!require("tidyverse")) 
        {install.packages("tidyverse", repos = 'http://cran.wu.ac.at/')
        library(tidyverse)}
if (!require("reshape2"))
        {install.packages("reshape2", repos = 'http://cran.wu.ac.at/')
        library(reshape2)}
if (!require("readxl"))
        {install.packages("readxl", repos = 'http://cran.wu.ac.at/')
        library(readxl)}
if (!require("pander"))
        {install.packages("pander", repos = 'http://cran.wu.ac.at/')
        library(pander)}


```

# Datenbereinigen

## Daten einspielen


Die Daten sind als Excel-Datei `umfrage-tirol.xlsx` vorhanden. Die Excel-Datei hat 5 Blätter (sheets). Ich lade vorerst nur das erste Blatt in R ein und speichere es in ein für R lesbares Format ab. 


```{r load-first-sheet-of-excel-file-into-r-memory}

tirol-umfrage.1 <- read_excel(
        "daten/umfrage-tirol.xlsx",
        sheet = 1,
        col_names = TRUE,
        col_types = NULL,
        na = "",
        skip = 0
        )
saveRDS(tirol-umfrage.1, file = "tirol-umfrage.1.rds")

```

## Grundsätzliche Überlegungen zur Datenstruktur
Leider sind die Daten in einer nicht zu bearbeitenden Form erfasst worden. Richtig wäre gewesen: 

* Es gehört für jede befragte Person (= Beobachtung) eine eine Zeile. 
* Es gehört für jede Frage (= Variable) eine eigene Spalte, in der dann die entsprechende Ausprägung der Antwort eingetragen wird.

Statt dessen wurden Personen als Spalten geführt und die Fragen als Zeilen. Dazu kommt auch noch, dass die für jede einzelne Ausprägung eine eigene Zeile genommen wurde, was zu einer großen Anzahl leerer Felder führt, die als `NA`s (data "Not Available"") interpretiert werden.

Bevor weitergearbeitet werden kann, müssen die Daten "aufgeräumt"" werden. Dieses Konzept heißt [tidy data](https://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html).

Für die weiteren Transformationen der Datei lege ich ein neues Datenset an, das ich `tirol` nenne.
Der erste Schritt ist es, dass Zeilen und Spalten verdreht werden. Dies geschieht mit der Funktion `t` (= transpose). `t` erzeugt eine Matrix; ich bevorzuge aber weiterhin im `tibble`-Format zu bleiben. 

```{r}
tirol.1 <- as_tibble(t(tirol-umfrage.1))
```

Als Ergebnis bekomme ich nun ein Datenset, wo für jede Spalte eine Variable vorgesehen wird. Allerdings ist nicht nur der Text der Frage eine Variable, sondern auch jeder ihrer möglichen Antworten. Die Merkmalsausprägungen gehören zusammen mit der Frage zu einer einzigen Variablen zusammengefasst.

Ein Beispiel: Die Fragen "An welchem Schultyp unterrichten Sie?" (V2) hat die Ausprägungen `AHS`, `NMS` und `PTS` (V3, V4, V5) und gehört zu einer Variablen `schultyp` zusammengefasst. Das heißt V2 bis V5 gehört zu einer Variable `schultyp` zusammen gefasst. Die Herausforderung dabei ist, dass die jeweiligen Kreuze in den Variablen mit dem jeweiligen Wert der Ausprägung ersetzt werden muss.

Dazu muss die entsprechende Variable selektiert werden und jedes "x" mit dem entsprechenden Wert der jeweiligen Spalte überschrieben werden. Also beispielsweise müssen alle "x" in Variable V3 mit "AHS", alle "x" in V4 mit "NMS" und alle V5 mit "PTS" ersetzt werden. Außerdem müssen  diese  Ergebnisse in einer einzigen Variable zusammengefasst werden. Danach kann sowohl die Frage (V2) als auch die nicht mehr benötigten anderen Variablen dieser Frage gelöscht werden. Schlussendlich noch kann die entsprechende - nun korrekt ausgefüllte - Variable in `schultyp` umbenannt werden. Gleichzeitig muss ein Code-Buch entwickelt werden, in dem die Fragestellung, der Code der Variable und die Ausprägungen eingetragen werden.

## Ausprägungen in Variable überführen

Untenstehendes Programm-Snippet kann sinnvollerweise nur einmal ausgeführt werden. Ich habe es deshalb als Kommentar `#` inaktiv gesetzt.

```{r auspraegungen-in-variable-ueberfuehren}

# schultyp
tirol$V2[tirol$V3 == "x"] <- "AHS"
tirol$V2[tirol$V4 == "x"] <- "NMS"
tirol$V2[tirol$V5 == "x"] <- "PTS"
names(tirol)[names(tirol) == 'V2'] <- 'schultyp'

# pc.ja
tirol$V7[tirol$V8 == "x"] <- "1"
tirol$V7[tirol$V9 == "x"] <- "2"
tirol$V7[tirol$V10 == "x"] <- "3"
tirol$V7[tirol$V11 == "x"] <- "4"
tirol$V7[tirol$V12 == "x"] <- "5"
names(tirol)[names(tirol) == 'V7'] <- 'pc.ja'

# pc.nein
tirol$V13[tirol$V14 == "x"] <- "1"
tirol$V13[tirol$V15 == "x"] <- "2"
tirol$V13[tirol$V16 == "x"] <- "3"
tirol$V13[tirol$V17 == "x"] <- "4"
tirol$V13[tirol$V18 == "x"] <- "5"
names(tirol)[names(tirol) == 'V13'] <- 'pc.nein'

# tablet
tirol$V19[tirol$V20 == "x"] <- "1"
tirol$V19[tirol$V21 == "x"] <- "2"
tirol$V19[tirol$V22 == "x"] <- "3"
tirol$V19[tirol$V23 == "x"] <- "4"
tirol$V19[tirol$V24 == "x"] <- "5"
names(tirol)[names(tirol) == 'V19'] <- 'tablet'

# lan
tirol$V25[tirol$V26 == "x"] <- "1"
tirol$V25[tirol$V27 == "x"] <- "2"
tirol$V25[tirol$V28 == "x"] <- "3"
tirol$V25[tirol$V29 == "x"] <- "4"
tirol$V25[tirol$V30 == "x"] <- "5"
names(tirol)[names(tirol) == 'V25'] <- 'lan'

# wlan
tirol$V31[tirol$V32 == "x"] <- "1"
tirol$V31[tirol$V33 == "x"] <- "2"
tirol$V31[tirol$V34 == "x"] <- "3"
tirol$V31[tirol$V35 == "x"] <- "4"
tirol$V31[tirol$V36 == "x"] <- "5"
names(tirol)[names(tirol) == 'V31'] <- 'wlan'

# beamer
tirol$V37[tirol$V38 == "x"] <- "1"
tirol$V37[tirol$V39 == "x"] <- "2"
tirol$V37[tirol$V40 == "x"] <- "3"
tirol$V37[tirol$V41 == "x"] <- "4"
tirol$V37[tirol$V42 == "x"] <- "5"
names(tirol)[names(tirol) == 'V37'] <- 'beamer'

# whiteboard
tirol$V43[tirol$V44 == "x"] <- "1"
tirol$V43[tirol$V45 == "x"] <- "2"
tirol$V43[tirol$V46 == "x"] <- "3"
tirol$V43[tirol$V47 == "x"] <- "4"
tirol$V43[tirol$V48 == "x"] <- "5"
names(tirol)[names(tirol) == 'V43'] <- 'whiteboard'

# kopfhoerer
tirol$V49[tirol$V50 == "x"] <- "1"
tirol$V49[tirol$V51 == "x"] <- "2"
tirol$V49[tirol$V52 == "x"] <- "3"
tirol$V49[tirol$V53 == "x"] <- "4"
tirol$V49[tirol$V54 == "x"] <- "5"
names(tirol)[names(tirol) == 'V49'] <- 'kopfhoerer'

names(tirol)[names(tirol) == 'V55'] <- 'kommentar'

# tirol[c(2, 4, 5)] <- list(NULL)
# tirol[c(3, 5:9)] <- list(NULL)
```

Wie oben gehört jetzt entsprechend mit jeder Variablen verfahren. Gleichzeitig müsste jedoch die Code-Tabelle erstellt werden. Das mache ich später, bzw. könnte ich delegieren.

```{r loesche-ueberfluessige-spalten}

tirol <- slice(tirol, 3:n())
tirol[c(1, 3:6, 8:12, 14:18, 20:24, 26:30, 32:36, 38:42, 44:48, 50:54)] <- list(NULL)
```

# Datensatz bereinigt speichern


```{r speichere-bereinigte-datei-unter-neuen-namen}
saveRDS(tirol, file = "umfrage.1.rds")
```
